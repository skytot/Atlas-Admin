# Authæ¨¡å—æ¶æ„æ–‡æ¡£

## ğŸ—ï¸ æ¶æ„æ¦‚è¿°

Authæ¨¡å—é‡‡ç”¨**å•ä¸€æ•°æ®æºæ¶æ„**è®¾è®¡ï¼Œä½œä¸ºå”¯ä¸€çš„ç”¨æˆ·çŠ¶æ€æ•°æ®æºå’ŒæŒä¹…åŒ–å±‚ï¼Œé€šè¿‡ç‹¬ç«‹çš„æŒä¹…åŒ–é€‚é…å™¨å®ç°ç»Ÿä¸€çŠ¶æ€ç®¡ç†ã€‚

### æ¶æ„å±‚æ¬¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                ç»„ä»¶å±‚                    â”‚
â”‚  (é€šè¿‡ useUserStore è®¿é—®çŠ¶æ€)            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†•
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                æ¶ˆè´¹ç«¯                    â”‚
â”‚           (UserStore - Pinia)            â”‚
â”‚  - å“åº”å¼çŠ¶æ€å±•ç¤º                        â”‚
â”‚  - ä¸ç‹¬ç«‹å­˜å‚¨æ•°æ®                        â”‚
â”‚  - ä»Authè·å–çŠ¶æ€                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†•
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                æ¡¥æ¢å±‚                    â”‚
â”‚            (AuthBridge)                 â”‚
â”‚  - æ•°æ®åŒæ­¥æ¡¥æ¢                          â”‚
â”‚  - çŠ¶æ€ä¼ é€’æœºåˆ¶                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†•
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                æ•°æ®æº                    â”‚
â”‚            (Auth Module)                â”‚
â”‚  - å”¯ä¸€æ•°æ®æº                            â”‚
â”‚  - ç™»å½•/ç™»å‡ºé€»è¾‘                         â”‚
â”‚  - æƒé™æ£€æŸ¥é€»è¾‘                          â”‚
â”‚  - ä»¤ç‰Œç®¡ç†é€»è¾‘                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†•
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              æŒä¹…åŒ–å±‚                    â”‚
â”‚        (AuthPersistenceAdapter)         â”‚
â”‚  - ç»Ÿä¸€å­˜å‚¨è®¿é—®                          â”‚
â”‚  - æ•°æ®åºåˆ—åŒ–                            â”‚
â”‚  - çŠ¶æ€æ¢å¤                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“ æ–‡ä»¶ç»“æ„

```
src/core/auth/
â”œâ”€â”€ index.ts              # ä¸»å…¥å£ï¼Œç»Ÿä¸€è®¤è¯API
â”œâ”€â”€ persistence.ts         # æŒä¹…åŒ–é€‚é…å™¨
â”œâ”€â”€ auth-service.ts        # AuthServiceç±»ï¼ˆå¯é€‰ï¼‰
â”œâ”€â”€ init.ts               # åˆå§‹åŒ–æ¨¡å—
â”œâ”€â”€ types.ts              # ç±»å‹å®šä¹‰
â”œâ”€â”€ README.md             # ä½¿ç”¨æ–‡æ¡£
â”œâ”€â”€ USAGE.md              # ä½¿ç”¨æŒ‡å—
â””â”€â”€ ARCHITECTURE.md       # æ¶æ„æ–‡æ¡£

src/core/store/modules/user/
â”œâ”€â”€ user.store.ts         # ç”¨æˆ·çŠ¶æ€ç®¡ç†
â”œâ”€â”€ integrations.ts       # é›†æˆæ¨¡å—ï¼ˆå·²ç®€åŒ–ï¼‰
â”œâ”€â”€ types.ts              # ç”¨æˆ·çŠ¶æ€ç±»å‹
â””â”€â”€ ...
```

## ğŸš€ ä½¿ç”¨æ–¹å¼

### 1. åŸºæœ¬ä½¿ç”¨ï¼ˆæ¨èï¼‰

```typescript
// å¯¼å…¥è®¤è¯æ¨¡å—
import { auth } from '@/core/auth'
import { useUserStore } from '@/core/store/modules/user'

// åœ¨ç»„ä»¶ä¸­ä½¿ç”¨
const userStore = useUserStore()

// ä¸šåŠ¡é€»è¾‘
await auth.login(credentials)

// çŠ¶æ€è®¿é—®
console.log(userStore.isAuthenticated)
```

### 2. é«˜çº§ç”¨æ³•ï¼ˆæŒ‰éœ€å¯¼å…¥ï¼‰

```typescript
// åˆ›å»ºè‡ªå®šä¹‰è®¤è¯æœåŠ¡
import { AuthService } from '@/core/auth'
import { localAuthPersistence } from '@/core/auth'

const customAuthService = new AuthService(localAuthPersistence)
```

## ğŸ”§ æ ¸å¿ƒç»„ä»¶

### Authæ¨¡å—ï¼ˆå”¯ä¸€æ•°æ®æºï¼‰

```typescript
export const auth = {
  // ç™»å½•ï¼ˆæ•°æ®æºæ“ä½œï¼‰
  async login(credentials: LoginCredentials): Promise<AuthResponse>
  
  // ç™»å‡ºï¼ˆæ•°æ®æºæ“ä½œï¼‰
  logout(): void
  
  // æƒé™æ£€æŸ¥ï¼ˆæ•°æ®æºæŸ¥è¯¢ï¼‰
  hasPermission(permission: string): boolean
  hasRole(role: string): boolean
  
  // ä»¤ç‰Œç®¡ç†
  getToken(): string | null
  isTokenExpired(token?: string): boolean
  async refreshToken(): Promise<string>
  
  // çŠ¶æ€æ¢å¤
  restore(): void
}
```

### UserStoreï¼ˆæ¶ˆè´¹ç«¯ï¼‰

```typescript
export const useUserStore = defineStore('user', {
  state: () => ({
    name: '',
    token: '',
    permissions: [],
    roles: [],
    lastLoginTime: undefined
  }),
  
  getters: {
    isAuthenticated: state => Boolean(state.token),
    hasPermission: state => (permission: string) => 
      state.permissions.includes(permission),
    hasRole: state => (role: string) => 
      state.roles?.includes(role) || false
  },
  
  actions: {
    // ä»Authæ¨¡å—è·å–çŠ¶æ€ï¼ˆæ¶ˆè´¹ç«¯æ“ä½œï¼‰
    restoreFromAuth(): void
    // é€šè¿‡Authæ¨¡å—æ›´æ–°æƒé™ï¼ˆä¸ç›´æ¥ä¿®æ”¹ï¼‰
    updatePermissions(permissions: string[]): void
  }
})
```

### AuthPersistenceAdapterï¼ˆæŒä¹…åŒ–å±‚ï¼‰

```typescript
export interface AuthPersistenceAdapter {
  save(data: AuthState): void
  load(): AuthState | null
  clear(): void
}

export const localAuthPersistence: AuthPersistenceAdapter = {
  save(data: AuthState) {
    storage.set('auth_state', data, { type: 'localStorage', serialize: true })
  },
  load(): AuthState | null {
    return storage.get<AuthState>('auth_state', { type: 'localStorage', serialize: true })
  },
  clear() {
    storage.remove('auth_state')
  }
}
```

## ğŸ“Š æ¶æ„ä¼˜åŠ¿

| ç‰¹æ€§ | ç»Ÿä¸€æŒä¹…åŒ–æ¶æ„ | åˆ†å±‚æ¶æ„ | å•ä¸€æ¨¡å— |
|------|----------------|----------|----------|
| **èŒè´£åˆ†ç¦»** | âœ… æ¸…æ™° | âœ… æ¸…æ™° | âŒ æ··ä¹± |
| **å¯æµ‹è¯•æ€§** | âœ… é«˜ | âœ… é«˜ | âŒ ä½ |
| **å¯ç»´æŠ¤æ€§** | âœ… é«˜ | âœ… é«˜ | âŒ ä½ |
| **å¯æ‰©å±•æ€§** | âœ… é«˜ | âœ… é«˜ | âŒ ä½ |
| **çŠ¶æ€ä¸€è‡´æ€§** | âœ… ä¿è¯ | âœ… ä¿è¯ | âŒ å¯èƒ½å†²çª |
| **å­˜å‚¨å†²çª** | âœ… æ—  | âŒ å­˜åœ¨ | âŒ å­˜åœ¨ |
| **æ•°æ®åŒæ­¥** | âœ… è‡ªåŠ¨ | âŒ æ‰‹åŠ¨ | âŒ æ‰‹åŠ¨ |
| **åˆå§‹åŒ–** | âœ… è‡ªåŠ¨ | âŒ æ‰‹åŠ¨ | âŒ æ‰‹åŠ¨ |

## ğŸ¯ è®¾è®¡åŸåˆ™

1. **ç»Ÿä¸€æŒä¹…åŒ–**ï¼šAuthPersistenceAdapterä½œä¸ºå”¯ä¸€çš„å­˜å‚¨è®¿é—®ç‚¹
2. **å•ä¸€æ•°æ®æº**ï¼šAuthæ¨¡å—ä½œä¸ºå”¯ä¸€çš„çŠ¶æ€ç®¡ç†
3. **è‡ªåŠ¨åŒæ­¥**ï¼šUserStoreä»Authæ¨¡å—è‡ªåŠ¨æ¢å¤çŠ¶æ€
4. **æŒ‰éœ€å¯¼å…¥**ï¼šæ— éœ€æ’ä»¶æŒ‚è½½ï¼ŒæŒ‰éœ€ä½¿ç”¨
5. **å‘åå…¼å®¹**ï¼šä¿æŒåŸæœ‰APIæ¥å£ä¸å˜

## ğŸ”„ æ•°æ®æµ

```
ç”¨æˆ·æ“ä½œ â†’ Authæ¨¡å— â†’ AuthPersistenceAdapter â†’ Storage
    â†“           â†“              â†“
  ä¸šåŠ¡é€»è¾‘    çŠ¶æ€ç®¡ç†      æŒä¹…åŒ–å­˜å‚¨
    â†“
UserStore â†’ ç»„ä»¶æ›´æ–°
    â†“
å“åº”å¼æ›´æ–°
```

## ğŸ› ï¸ æ‰©å±•æŒ‡å—

### æ·»åŠ æ–°çš„è®¤è¯é€»è¾‘

1. åœ¨`AuthService`ä¸­æ·»åŠ æ–¹æ³•
2. é€šè¿‡`AuthBridge`æ›´æ–°çŠ¶æ€
3. åœ¨`UserStore`ä¸­æ·»åŠ ç›¸åº”çš„getter

### æ·»åŠ æ–°çš„çŠ¶æ€å­—æ®µ

1. æ›´æ–°`UserState`ç±»å‹
2. æ›´æ–°`UserPayload`ç±»å‹
3. åœ¨`AuthBridge`ä¸­æ·»åŠ åŒæ­¥æ–¹æ³•
4. åœ¨`AuthService`ä¸­æ·»åŠ ä¸šåŠ¡é€»è¾‘

## ğŸ“ æœ€ä½³å®è·µ

1. **ä½¿ç”¨AuthServiceå¤„ç†ä¸šåŠ¡é€»è¾‘**
2. **é€šè¿‡UserStoreè®¿é—®çŠ¶æ€**
3. **é¿å…ç›´æ¥æ“ä½œstorage**
4. **åˆ©ç”¨å“åº”å¼ç‰¹æ€§è‡ªåŠ¨æ›´æ–°UI**
5. **ä¿æŒAPIçš„ä¸€è‡´æ€§**
